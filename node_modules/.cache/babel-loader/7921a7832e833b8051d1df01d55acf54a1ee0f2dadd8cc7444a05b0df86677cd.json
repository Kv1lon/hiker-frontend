{"ast":null,"code":"import { FontAwesomeIcon } from \"@fortawesome/vue-fontawesome\";\nimport Multiselect from \"@vueform/multiselect\";\nimport VueNumberInput from \"@chenfengyuan/vue-number-input\";\nimport { useToast } from \"vue-toastification\";\nimport f from \"./airport.csv\";\nimport md from \"./flightsearch.md\";\nimport axios from \"axios\";\nexport default {\n  name: \"ticket_single\",\n  inheritAttrs: false,\n  emits: ['confirm', 'cancel'],\n  components: {\n    'font-awesome-icon': FontAwesomeIcon,\n    Multiselect,\n    VueNumberInput\n  },\n  data: () => ({\n    listPosts: [],\n    popular: [],\n    user: {},\n    total: 0,\n    date: \"\",\n    adult: 1,\n    teen: 0,\n    baby: 0,\n    forward: '',\n    back: '',\n    reqs: [],\n    tickets_i: {\n      it: 0,\n      fl: 0,\n      tr: 0\n    },\n    trip_class: '',\n    food: {\n      \"MEAL\": \"Їжа\",\n      \"FRESH_MEAL\": \"Свіжа їжа \",\n      \"SNACK\": \"Снеки\",\n      \"FRESH_SNACK\": \"Свіжі снеки\"\n    },\n    power: {\n      \"PLUG\": \"Штекер\",\n      \"USB_PORT\": \"USB\",\n      \"ADAPTOR\": \"Адаптер\",\n      \"PLUG_OR_USB_PORT\": \"Штекер або USB\"\n    },\n    beverage: {\n      \"ALCOHOLIC\": \"Алкогольні\",\n      \"NON_ALCOHOLIC\": \"Безалкогольні\",\n      \"ALCOHOLIC_AND_NON_ALCOHOLIC\": \"алкогольні і безалкогольні\"\n    },\n    entertainment: {\n      \"LIVE_TV\": \"TV\",\n      \"MOVIES\": \"фильмы\",\n      \"AUDIO_VIDEO_ON_DEMAND\": \"аудіо і відео\",\n      \"TV_SHOWS\": \"TV шоу\",\n      \"IP_TV\": \"IP TV\"\n    },\n    travalerType: {\n      \"ADULT\": \"Дорослий\",\n      \"CHILD\": \"Дитина\",\n      \"SENIOR\": \"Похилого віку\",\n      \"YOUNG\": \"Молодий\",\n      \"HELD_INFANT\": \"Немовля\",\n      \"SEATED_INFANT\": \"Сидяче немовля\",\n      \"STUDENT\": \"Ученик\"\n    },\n    fareType: {\n      \"STANDARD\": \"Стандарт\",\n      \"INCLUSIVE_TOUR\": \"Інклюзивный тур\",\n      \"ADULT_WITH_COMPANION\": \"Дорослий із супутником\",\n      \"COMPANION\": \"Супутник\"\n    },\n    timezone: \"UTC\",\n    traveler_id: 1,\n    modelConfig: {\n      type: 'string',\n      mask: 'YYYY-MM-DD hh:mm:ss',\n      timeAdjust: '24:00:00'\n    },\n    show: false,\n    show_s: false,\n    orl: \"\",\n    del: \"\",\n    op: {},\n    arar: {},\n    ticket: {},\n    travelers_info: [],\n    seatmaps: [],\n    toast: useToast(),\n    loading: false\n  }),\n  created() {\n    this.loadTicket();\n    this.loadPopularPosts();\n    this.user = this.$store.state.cuser;\n    var data_airports = this.loadCsv(f);\n    this.arar, this.op = data_airports;\n  },\n  mounted() {\n    console.log(this.$store.state);\n  },\n  methods: {\n    loadCsv(allText) {\n      var ops = [];\n      var mdd = md.join(\"\");\n      for (var i = 1; i < allText.length; i++) {\n        if (mdd.includes(allText[i][0])) {\n          var st = \"\";\n          for (var j = 0; j < allText[i].length - 2; j++) {\n            st += allText[i][j] + \" \";\n          }\n          allText[i].push(st);\n          ops.push(st);\n        }\n      }\n      allText.shift();\n      return allText, ops;\n    },\n    async loadPopularPosts() {\n      axios({\n        url: this.$store.state.backendUrl + `api/v1/blog?limit=3&search=&date=month&ordering=descending`,\n        method: 'GET',\n        headers: {\n          'Content-type': 'application/json'\n        }\n      }).then(response => {\n        this.popular = response.data.results;\n      });\n    },\n    async loadTicket() {\n      this.ticket = this.$store.state.ticket;\n      console.log(\"ticket = \");\n      console.log(this.$store.state.ticket);\n      this.loading = true;\n      var data = \"grant_type=client_credentials&client_id=JxlnVpGLZUn7fV3UPNYfT2IJc0lL1GbE&client_secret=t965p0PRI1cCBS9h\";\n      var token;\n      var access = localStorage.getItem('access');\n      if (access) {\n        delete axios.defaults.headers.common[\"Authorization\"];\n      }\n      await axios({\n        url: 'https://test.api.amadeus.com/v1/security/oauth2/token',\n        data: data,\n        method: 'POST',\n        headers: {\n          \"Content-type\": \"application/x-www-form-urlencoded\"\n        }\n      }).then(response => {\n        token = response.data.token_type + \" \" + response.data.access_token;\n      });\n      var ticket = this.ticket;\n      data = {\n        \"data\": {\n          \"type\": \"flight-offers-pricing\",\n          \"flightOffers\": [ticket]\n        }\n      };\n      axios({\n        url: 'https://test.api.amadeus.com/v1/shopping/flight-offers/pricing?forceClass=false',\n        method: 'POST',\n        data: data,\n        headers: {\n          \"Authorization\": token\n        }\n      }).then(res => {\n        this.ticket = res.data.data.flightOffers[0], console.log(this.ticket), this.reqs = res.data.data.bookingRequirements, this.loading = false;\n      }).catch(err => {\n        console.log(err), this.toast.error(\"Произошла ошибка или данный билет уже не доступен.\"), this.loading = false, localStorage.removeItem('tickets_arr');\n        setTimeout(function () {\n          this.goTo('tickets');\n        }, 5000);\n      });\n      access = localStorage.getItem('access');\n      if (access) {\n        axios.defaults.headers.common['Authorization'] = \"JWT \" + access;\n      }\n      data = {\n        \"data\": [ticket]\n      };\n      await axios({\n        url: 'https://test.api.amadeus.com/v1/shopping/seatmaps',\n        method: 'POST',\n        data: data,\n        headers: {\n          \"Authorization\": token\n        }\n      }).then(res => {\n        this.seatmaps = res.data.data;\n      }).catch(err => this.seatmaps = err);\n      for (var i = 0; i < this.ticket.travelerPricings.length; i++) {\n        this.travelers_info.push({\n          email: \"\",\n          full_name: \"\",\n          phone: \"\",\n          cityName: \"\",\n          countryCode: \"\",\n          address: \"\",\n          pc: \"\",\n          pcode: \"\",\n          city: \"\",\n          doc: \"\",\n          birth: \"\",\n          gender: \"\"\n        });\n        this.travelers_info[i].seats = [];\n        for (var j = 0; j < this.seatmaps.length; j++) {\n          this.travelers_info[i].seats.push({});\n        }\n      }\n    },\n    async searchTickets() {\n      var data = \"grant_type=client_credentials&client_id=JxlnVpGLZUn7fV3UPNYfT2IJc0lL1GbE&client_secret=t965p0PRI1cCBS9h\";\n      var token;\n      var access = localStorage.getItem('access');\n      if (access) {\n        delete axios.defaults.headers.common[\"Authorization\"];\n      }\n      this.loading = true;\n      await axios({\n        url: 'https://test.api.amadeus.com/v1/security/oauth2/token',\n        data: data,\n        method: 'POST',\n        headers: {\n          \"Content-type\": \"application/x-www-form-urlencoded\"\n        }\n      }).then(response => {\n        console.log(response), token = response.data.token_type + \" \" + response.data.access_token;\n      });\n      this.orl = this.orl.slice(0, 3);\n      this.del = this.del.slice(0, 3);\n      var date = this.forward.toString().slice(10);\n      var data1 = {\n        \"id\": 1,\n        \"originLocationCode\": this.orl,\n        \"destinationLocationCode\": this.del,\n        \"departureDateTimeRange\": {\n          \"date\": this.forward.slice(0, 10),\n          \"time\": this.forward.slice(11)\n        }\n      };\n      if (this.back[0]) {\n        var data2 = {\n          \"id\": 2,\n          \"originLocationCode\": this.del,\n          \"destinationLocationCode\": this.orl,\n          \"departureDateTimeRange\": {\n            \"date\": this.back.slice(0, 10),\n            \"time\": this.back.slice(11)\n          }\n        };\n        var dd = [data1, data2];\n      } else {\n        var dd = [data1];\n      }\n      var travelers = [];\n      var c = 0;\n      for (var i = 0; i < this.adult; i++) {\n        c++;\n        travelers.push({\n          \"id\": c,\n          \"travelerType\": \"ADULT\"\n        });\n      }\n      for (var i = 0; i < this.teen; i++) {\n        c++;\n        travelers.push({\n          \"id\": c,\n          \"travelerType\": \"CHILD\"\n        });\n      }\n      for (var i = 0; i < this.baby; i++) {\n        c++;\n        if (i < this.adult) {\n          travelers.push({\n            \"id\": c,\n            \"travelerType\": \"HELD_INFANT\",\n            \"associatedAdultId\": i + 1\n          });\n        }\n      }\n      var cabin = \"\";\n      if (this.trip_class === \"E\") {\n        cabin = \"ECONOMY\";\n      } else if (this.trip_class === \"PE\") {\n        cabin = \"PREMIUM_ECONOMY\";\n      } else if (this.trip_class === \"B\") {\n        cabin = \"BUSINESS\";\n      } else if (this.trip_class === \"F\") {\n        cabin = \"FIRST\";\n      }\n      var d = {\n        \"currencyCode\": \"USD\",\n        \"originDestinations\": dd,\n        \"travelers\": travelers,\n        \"sources\": [\"GDS\"],\n        \"searchCriteria\": {\n          \"maxFlightOffers\": 20,\n          \"flightFilters\": {\n            \"cabinRestrictions\": [{\n              \"cabin\": cabin,\n              \"coverage\": \"MOST_SEGMENTS\",\n              \"originDestinationIds\": [\"1\"]\n            }],\n            \"carrierRestrictions\": {\n              \"excludedCarrierCodes\": [\"AA\", \"TP\", \"AZ\"]\n            }\n          }\n        }\n      };\n      var that = this;\n      await axios({\n        url: 'https://test.api.amadeus.com/v2/shopping/flight-offers',\n        data: d,\n        method: 'POST',\n        headers: {\n          \"Authorization\": token\n        }\n      }).then(res => {\n        if (res.data.data[0]) {\n          data = res.data.data;\n          this.loading = false, data = res.data.data, console.log(this.$store.state);\n          this.$store.dispatch('tickets_arr', {\n            data\n          }), this.goTo(\"tickets\");\n        } else {\n          that.toast.error(\"Нет билетов в наличии\"), this.loading = false;\n        }\n      }).catch(err => {\n        console.log(err), that.toast.error(\"Введите валидные данные или попробуйте позже\"), this.loading = false;\n      });\n      console.log(this.$store.state.tickets);\n      access = localStorage.getItem('access');\n      if (access) {\n        axios.defaults.headers.common['Authorization'] = \"JWT \" + access;\n      }\n    },\n    goTo(name, params) {\n      let r = this.$router.resolve({\n        name: name,\n        params: params // put your route information in\n      });\n\n      window.location.assign(r.href);\n    },\n    format_date(data) {\n      if (data.includes(\"-\")) {\n        return data.slice(0, 10).replaceAll(\"-\", \".\") + \" \" + data.slice(11, 16);\n      } else if (data.includes(\"P\")) {\n        return data.replaceAll(\"P\", \"\").replaceAll(\"T\", \"\").replaceAll(\"D\", \" день(дней) \").replaceAll(\"H\", \" час(ов) \").replaceAll(\"M\", \" минут(а) \");\n      }\n    },\n    next_flight(ticket) {\n      if (this.tickets_i['fl'] < ticket.itineraries[this.tickets_i['it']].segments.length - 1) {\n        this.tickets_i['fl']++;\n      } else if (this.tickets_i['fl'] >= ticket.itineraries[this.tickets_i['it']].segments.length - 1 && this.tickets_i['it'] < ticket.itineraries.length - 1) {\n        this.tickets_i['it']++;\n        this.tickets_i['fl'] = 0;\n      }\n    },\n    prev_flight(ticket) {\n      if (this.tickets_i['fl'] > 0) {\n        this.tickets_i['fl']--;\n      } else if (this.tickets_i['fl'] === 0 && this.tickets_i['it'] > 0) {\n        this.tickets_i['it']--;\n        this.tickets_i['fl'] = ticket.itineraries[this.tickets_i['it']].segments.length - 1;\n      }\n    },\n    select_seat(r, c) {\n      if (this.travelers_info[this.tickets_i['tr']].seats[this.tickets_i['fl'] + this.tickets_i['it'] * this.ticket.itineraries[this.tickets_i['it']].segments.length].seat) {\n        if (this.travelers_info[this.tickets_i['tr']].seats[this.tickets_i['fl'] + this.tickets_i['it'] * this.ticket.itineraries[this.tickets_i['it']].segments.length].seat.number === this.seatmaps[this.tickets_i['fl']].decks[0].seats.find(x => x.coordinates.x === r - 1 && x.coordinates.y === c - 1).number) {\n          this.travelers_info[this.tickets_i['tr']].seats[this.tickets_i['fl'] + this.tickets_i['it'] * this.ticket.itineraries[this.tickets_i['it']].segments.length] = {};\n        } else {\n          this.travelers_info[this.tickets_i['tr']].seats[this.tickets_i['fl'] + this.tickets_i['it'] * this.ticket.itineraries[this.tickets_i['it']].segments.length].seat = this.seatmaps[this.tickets_i['fl']].decks[0].seats.find(x => x.coordinates.x === r - 1 && x.coordinates.y === c - 1);\n        }\n      } else {\n        this.travelers_info[this.tickets_i['tr']].seats[this.tickets_i['fl'] + this.tickets_i['it'] * this.ticket.itineraries[this.tickets_i['it']].segments.length].seat = this.seatmaps[this.tickets_i['fl']].decks[0].seats.find(x => x.coordinates.x === r - 1 && x.coordinates.y === c - 1);\n      }\n    },\n    validate_seat(seat) {\n      var t = false;\n      for (var i = 0; i < this.ticket.travelerPricings.length; i++) {\n        if (this.travelers_info[i].seats[this.tickets_i['fl'] + this.tickets_i['it'] * this.ticket.itineraries[this.tickets_i['it']].segments.length].seat) {\n          if (this.travelers_info[i].seats[this.tickets_i['fl'] + this.tickets_i['it'] * this.ticket.itineraries[this.tickets_i['it']].segments.length].seat.number === seat && this.tickets_i['tr'] !== i) {\n            t = true;\n          }\n        }\n      }\n      return t;\n    },\n    async buy() {\n      var p;\n      this.ticket = this.$store.state.ticket;\n      this.loading = true;\n      var data = \"grant_type=client_credentials&client_id=JxlnVpGLZUn7fV3UPNYfT2IJc0lL1GbE&client_secret=t965p0PRI1cCBS9h\";\n      var token;\n      var access = localStorage.getItem('access');\n      if (access) {\n        delete axios.defaults.headers.common[\"Authorization\"];\n      }\n      await axios({\n        url: 'https://test.api.amadeus.com/v1/security/oauth2/token',\n        data: data,\n        method: 'POST',\n        headers: {\n          \"Content-type\": \"application/x-www-form-urlencoded\"\n        }\n      }).then(response => {\n        token = response.data.token_type + \" \" + response.data.access_token;\n      });\n      var ticket = this.ticket;\n      for (var i = 0; i < ticket.travelerPricings.length; i++) {\n        for (var j = 0; j < this.travelers_info[i].seats.length; j++) {\n          if (this.travelers_info[i].seats[j].seat) {\n            ticket.travelerPricings[i].fareDetailsBySegment[j]['additionalServices'] = {\n              \"chargeableSeatNumber\": this.travelers_info[i].seats[j].seat.number\n            };\n          }\n        }\n      }\n      data = {\n        \"data\": {\n          \"type\": \"flight-offers-pricing\",\n          \"flightOffers\": [ticket]\n        }\n      };\n      var that = this;\n      await axios({\n        url: 'https://test.api.amadeus.com/v1/shopping/flight-offers/pricing?forceClass=false',\n        method: 'POST',\n        data: data,\n        headers: {\n          \"Authorization\": token\n        }\n      }).then(res => {\n        this.ticket = res.data.data.flightOffers[0], this.reqs = res.data.data.bookingRequirements, p = res.data.data.flightOffers[0];\n      }).catch(err => {\n        console.log(err), this.toast.error(\"Произошла ошибка или данный билет уже не доступен.\"), this.loading = false, localStorage.removeItem('tickets_arr');\n        setTimeout(function () {\n          that.goTo('tickets');\n        }, 5000);\n      });\n      var travelers = [];\n      for (var k = 0; k < this.ticket.travelerPricings.length; k++) {\n        travelers.push({});\n        travelers[k]['id'] = this.ticket.travelerPricings[k].travelerId;\n        if (this.travelers_info[k]['birth'] !== \"\") {\n          travelers[k]['dateOfBirth'] = this.travelers_info[k]['birth'];\n        }\n        if (this.travelers_info[k]['gender'] !== \"\") {\n          travelers[k]['gender'] = this.travelers_info[k]['gender'];\n        }\n        travelers[k]['contact'] = {};\n        if (this.travelers_info[k]['email'] !== \"\") {\n          travelers[k]['contact']['emailAddress'] = this.travelers_info[k]['email'];\n        }\n        travelers[k]['contact']['phones'] = [];\n        travelers[k]['contact']['phones'].push({});\n        if (this.travelers_info[k]['pc'] !== \"\") {\n          travelers[k]['contact']['phones'][0]['countryCallingCode'] = this.travelers_info[k]['pc'];\n        }\n        if (this.travelers_info[k]['phone'] !== \"\") {\n          travelers[k]['contact']['phones'][0]['deviceType'] = \"MOBILE\";\n          travelers[k]['contact']['phones'][0]['number'] = this.travelers_info[k]['phone'];\n        }\n        travelers[k]['address'] = {};\n        if (this.travelers_info[k]['pcode'] !== \"\") {\n          travelers[k]['address']['postalCode'] = this.travelers_info[k]['pcode'];\n        }\n        travelers[k]['name'] = {\n          firstName: this.travelers_info[k]['full_name'].split(' ')[0],\n          lastName: this.travelers_info[k]['full_name'].split(' ')[1]\n        };\n      }\n      var contacts = [];\n      contacts.push({});\n      contacts[0]['address'] = {};\n      if (this.travelers_info[0]['cityName'] !== \"\") {\n        contacts[0]['address']['cityName'] = this.travelers_info[0]['cityName'];\n      }\n      if (this.travelers_info[0] && this.travelers_info[0]['countryCode'] !== \"\") {\n        contacts[0]['address']['countryCode'] = this.travelers_info[0]['countryCode'];\n        contacts[0]['address']['postalCode'] = this.travelers_info[0]['pcode'];\n      }\n      if (this.travelers_info[0] && this.travelers_info['address'] !== \"\") {\n        contacts[0]['address']['lines'] = [this.travelers_info[0]['address']];\n      }\n      contacts[0]['addresseeName'] = {\n        firstName: this.travelers_info[0]['full_name'].split(' ')[0],\n        lastName: this.travelers_info[0]['full_name'].split(' ')[1]\n      };\n      contacts[0][\"companyName\"] = \"AMADEUS\";\n      contacts[0][\"purpose\"] = \"STANDART\";\n      contacts[0][\"emailAddress\"] = this.travelers_info[0]['email'];\n      contacts[0][\"phones\"] = [];\n      contacts[0][\"phones\"].push({});\n      if (this.travelers_info[0]['phone'] !== \"\") {\n        contacts[0][\"phones\"][0]['deviceType'] = \"MOBILE\";\n        contacts[0][\"phones\"][0]['number'] = this.travelers_info[0]['phone'];\n      }\n      if (this.travelers_info[0]['pc'] !== \"\") {\n        contacts[0]['phones'][0]['countryCallingCode'] = this.travelers_info[k]['pc'];\n      }\n      console.log(this.ticket === p);\n      console.log(this.ticket);\n      console.log(p);\n      data = {\n        \"data\": {\n          \"type\": \"flight-order\",\n          \"flightOffers\": [p],\n          \"travelers\": travelers,\n          \"contacts\": contacts\n        }\n      };\n      await axios({\n        url: 'https://test.api.amadeus.com/v1//booking/flight-orders',\n        method: 'POST',\n        data: data,\n        headers: {\n          \"Authorization\": token\n        }\n      }).then(res => {\n        this.toast.success(\"Билет забронировн\"), this.loading = false, console.log(res.data);\n        var data_ticket = res.data.data.id;\n        axios({\n          url: this.$store.state.backendUrl + 'api/v1/create_ticket',\n          method: 'POST',\n          data: {\n            text_id: data_ticket,\n            user_id: this.$store.state.cuser.id\n          },\n          headers: {\n            \"Authorization\": \"JWT \" + localStorage.getItem('access')\n          }\n        }).then(res => console.log(res.data.data));\n      }).catch(err => {\n        console.log(err.response.data.errors.find(e => e.code === 4926)), this.toast.error(\"Произошла ошибка или Вы ввели не валидные данные.\"), this.loading = false;\n        if (err.response.data.errors.find(e => e.code === 4926)) {\n          setTimeout(function () {\n            localStorage.removeItem('tickets_arr');\n            that.goTo('tickets');\n          }, 5000);\n        }\n      });\n      access = localStorage.getItem('access');\n      if (access) {\n        axios.defaults.headers.common['Authorization'] = \"JWT \" + access;\n      }\n    }\n  }\n};","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}